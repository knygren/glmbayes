---
title: "Chapter 4: Specifying Multivariate Normal Priors"
author: "Kjell Nygren"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Chapter 4: Specifying Multivariate Normal Priors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup,echo = FALSE}
library(glmbayes)
```

**General Discussion**

**The Age of Menarche Data**


As we discussed in chapter 2...

(rename this data to glmb_menarche and reference MASS package) 

```{r menarche data}
## Load menarche data
data(menarche2)
head(menarche2, 5)

```

```{r Analysis Setup}
## Number of variables in model
Age=menarche2$Age
nvars=2

## Reference Ages for setting of priors and Age_Difference
ref_age1=13  # user can modify this
ref_age2=15  ## user can modify this

## Define variables used later in analysis
Age2=Age-ref_age1
Age_Diff=ref_age2-ref_age1

```

```{r Prior Info}

## Point estimates at reference ages
m1=0.5  
m2=0.9

## Lower bound of prior credible intervals for point estimates
m1_lower=0.2
m2_lower=0.5

## specify correlation between the two
m_corr=0.2
```



**The Logit Model**

```{r Logit: set up link function info and initialize prior matrices}

## Set up link function and initialize prior
bi_logit <- binomial(link="logit")
mu1<-matrix(0,nrow=nvars,ncol=1)
V1<-1*diag(nvars)
```


Using this infomation, we can now derive our priors

```{r Logit:set prior means/sd}
## Prior mean for intercept is set to point estimate 
## at reference age1 (on logit scale)
mu1[1,1]=bi_logit$linkfun(m1)

## Prior mean for slope is set to difference in point estimates
## on logit scale divided by Age_Diff

mu1[2,1]=(bi_logit$linkfun(m2) -bi_logit$linkfun(m1))/Age_Diff 

## Implied standard deviations for point estimates on logit scale

sd_m1= (bi_logit$linkfun(m1) -bi_logit$linkfun(m1_lower))/1.96
sd_m2= (bi_logit$linkfun(m2) -bi_logit$linkfun(m2_lower))/1.96
sd_slope=sqrt(sd_m1^2+sd_m2^2-2*sd_m1*sd_m2*m_corr)

#Cov(m1,slope)=cov(m1, m2-m1)=E[(m1-E[m1])((m2-m1)-E[m2-m1])]
#   =E[(m1-E[m1])(m2-E[m2])]- E[(m1-E[m1])(m1-E[m1])]
##   =Cov[m1,m2] - Var[m1]
##  =sd_m1*sd_m2*m_corr+sd_m1*sd_m1
cov_V1=sd_m1*sd_m2*m_corr-sd_m1*sd_m1

# Set covariance matrix
V1[1,1]=sd_m1^2
V1[2,2]=sd_slope^2
V1[1,2]=cov_V1
V1[2,1]=V1[1,2]
```


```{r Logit: Prior Mean}
## Resulting Prior mean for model
mu1
```

```{r Logit: Prior Variance-Covariance Matrix}
## Resulting Prior Variance-Covariance for model
V1
```

This code is a test - Seems like the covariance make sense and the correlation matches that intended

```{r Check Prior}
#library(MASS)
#sim_test <- mvrnorm(1000, mu = mu1, Sigma = V1 ) # from MASS package
#colMeans(sim_test)
#var(sim_test)
#b=sim_test[,1]+sim_test[,2]
#mean(b)
#var(cbind(sim_test[,1],b))
```



```{r Run Logit,results = "hide"}
glmb.out1<-glmb(n=1000,cbind(Menarche, Total-Menarche) ~ Age2,family=binomial(logit),mu=mu1,Sigma=V1,Gridtype=1, data=menarche2)

## Run nonsense model to test predict function (this seemed to work)
#glmb.out1<-glmb(n=1000,cbind(Menarche, 2*Menarche) ~ #Age2,family=binomial(logit),mu=mu1,Sigma=V1,Gridtype=1, data=menarche2)

## Another nonsense model to test predict function (this does not work when predicting because the formula implies a fixed number of observations)
#glmb.out1<-glmb(n=1000,cbind(rep(5,25), rep(10,25)) ~ #Age2,family=binomial(logit),mu=mu1,Sigma=V1,Gridtype=1, data=menarche2)


```


```{r Summary Logit}
summary(glmb.out1)
```

```{r newdata}
newdata=matrix(0,nrow=5,ncol=2)
colnames(newdata)=c("Age","Age2")
newdata[1,1]=11
newdata[2,1]=12
newdata[3,1]=13
newdata[4,1]=14
newdata[5,1]=15

newdata[,2]=newdata[,1]-13
newdata= as.data.frame(newdata)

olddata=menarche2 # Set olddata=menarche2
olddata
olddata$Age2=Age2 # Add missing variables from environment
olddata

#formula(glmb.out1)[1]
#formula(glmb.out1)[2]
#formula(glmb.out1)[3]
newdata

pred_newdata=predict(glmb.out1,newdata=newdata,olddata=olddata)
pred_newdata=predict(glmb.out1,newdata=newdata,olddata=olddata,type="response")

colMeans(pred_newdata)
plot(colMeans(pred_newdata))
#colMeans(matrix(pred_newdata[,1],ncol=1))

```





**The Probit Model: **


```{r Probit: set up link function info and initialize prior matrices}
## Set up link function and initialize prior
bi_probit <- binomial(link="probit")
mu2<-matrix(0,nrow=nvars,ncol=1)
V2<-1*diag(nvars)
```

Using this infomation, we can now derive our priors

```{r Probit:set prior means/sd}
## Prior mean for intercept is set to point estimate 
## at reference age1 (on logit scale)
mu2[1,1]=bi_probit$linkfun(m1)

## Prior mean for slope is set to difference in point estimates
## on logit scale divided by Age_Diff

mu2[2,1]=(bi_probit$linkfun(m2) -bi_probit$linkfun(m1))/Age_Diff 

## Implied standard deviations for point estimates on logit scale

sd_m1= (bi_probit$linkfun(m1) -bi_probit$linkfun(m1_lower))/1.96
sd_m2= (bi_probit$linkfun(m2) -bi_probit$linkfun(m2_lower))/1.96
sd_slope=sqrt(sd_m1^2+sd_m2^2-2*sd_m1*sd_m2*m_corr)

#Cov(m1,slope)=cov(m1, m2-m1)=E[(m1-E[m1])((m2-m1)-E[m2-m1])]
#   =E[(m1-E[m1])(m2-E[m2])]- E[(m1-E[m1])(m1-E[m1])]
##   =Cov[m1,m2] - Var[m1]
##  =sd_m1*sd_m2*m_corr+sd_m1*sd_m1
cov_V2=sd_m1*sd_m2*m_corr-sd_m1*sd_m1

# Set covariance matrix
V2[1,1]=sd_m1^2
V2[2,2]=sd_slope^2
V2[1,2]=cov_V2
V2[2,1]=V2[1,2]
```

```{r Probit: Prior Mean}
## Resulting Prior mean for model
mu2
```

```{r Probit: Prior Variance-Covariance Matrix}
## Resulting Prior Variance-Covariance for model
V2
```

```{r Run Pobit,results = "hide"}
glmb.out2<-glmb(n=1000,cbind(Menarche, Total-Menarche) ~ Age2,family=binomial(probit),mu=mu2,Sigma=V2,Gridtype=1, data=menarche2)
```


```{r Summary Probit}
summary(glmb.out2)
```



```{r Probit Model}
n=1000
#################################################### Probit Model ############################################

mu<-matrix(0,nrow=2,ncol=1)
mu[2,1]=2*(0.9-0.5)/3 ## Implied Slope at age 13 should be 0.5*mu[1,1]*(0.9-0.5)/3 
V1<-1*diag(2)


# 2 standard deviations for prior estimate at age 13 between 0.1 and 0.9
## Specifies uncertainty around the point estimates

V1[1,1]=((0.9-0.5)/2)^2 
V1[2,2]=(3*mu[2,1]/2)^2  # Allows slope to be up to 3 times as large as point estimate 

  
glm.out2<-glm(cbind(Menarche,Total-Menarche)~Age2,family=binomial(probit), data=menarche2)
summary(glm.out2)

#  Note: Slope coefficient here is a bit more than half of the value of that in the logit model 

Like_std=summary(glm.out2)$coefficients[,2]
Menarche_Prior_Error_Checks=Prior_Likelihood_Check(mu,sqrt(diag(V1)),glm.out2$coefficients,Like_std)

glmb.out2<-glmb(n=n,cbind(Menarche,Total-Menarche)~Age2,family=binomial(probit),mu=mu,Sigma=V1,Gridtype=1,data=menarche2)
summary(glmb.out2)

# ~1.251 candidates per iid sample
```


**The Clog-Log Model:**

#################################################### Clog_Log Model ############################################

```{r Clog_Log Model}

# Need to improve the prior specification here 

mu<-matrix(0,nrow=2,ncol=1)
mu[1,1]=log(-log(1-0.5))  # Derived prior
1-exp(-exp((mu[1,1])))    # implies point estimate at age 13 is 0.5
mu[2,1]=(log(-log(1-0.9))-mu[1,1])/3 # implies 90% menarche at age 16


V1<-1*diag(2)
V1[1,1]=((log(-log(1-0.9))-mu[1,1])/2)^2  ## Corresponding standard deviation
V1[2,2]=(3*mu[2,1]/2)^2  # Allows slope to be up to 3 times as large as point estimate 


glm.out3 <-glm(cbind(Menarche, Total-Menarche) ~ Age2,family=binomial(cloglog), data=menarche2)
summary(glm.out3)

#1-exp(-exp(-0.59602))

Like_std=summary(glm.out3)$coefficients[,2]
Menarche_Prior_Error_Checks=Prior_Likelihood_Check(mu,sqrt(diag(V1)),glm.out3$coefficients,Like_std)


glmb.out3<-glmb(n=n,cbind(Menarche,Total-Menarche)~Age2,family=binomial(cloglog),mu=mu,Sigma=V1,Gridtype=1,data=menarche2)
summary(glmb.out3)

# Candidates per iid samples ~ 1.255

```

#!/bin/bash

echo "üîß Generating src/Makevars..."

# Clean old Makevars
rm -f src/Makevars


# ----------------------------
# üîç Detect OpenCL header
CL_HEADER=$(find /usr /usr/local /opt -type f -name cl.h 2>/dev/null | grep "/CL/cl.h" | head -n 1)

if [ -n "$CL_HEADER" ]; then
  CL_INC_DIR=$(dirname "$CL_HEADER")
  # Try to locate the OpenCL library using the header path
  CL_LIB_DIR=$(find /usr /usr/local /opt -type f -name libOpenCL.so 2>/dev/null | xargs -n1 dirname | head -n 1)
  echo "‚úÖ OpenCL found: header at $CL_INC_DIR, library at $CL_LIB_DIR"
  USE_OPENCL=1
else
  echo "‚ö†Ô∏è OpenCL not found. Will compile without it."
  USE_OPENCL=0
fi

# ----------------------------
TBB_CFLAGS=$(Rscript -e "RcppParallel::CxxFlags()")
TBB_LIBS=$(Rscript -e "RcppParallel::LdFlags()")


# ----------------------------
# üóÇÔ∏è Detect source files, exclude OpenCL ones if needed
##ALL_CPP=$(ls src/*.cpp | sed 's|src/||')
ALL_CPP=$(ls src/*.c src/*.cpp 2>/dev/null | sed 's|src/||')

EXCLUDED_CPP="load_kernel_source.cpp load_kernel_library.cpp"

if [ "$USE_OPENCL" = "1" ]; then
  FINAL_CPP="$ALL_CPP"
else
  # Filter out excluded files
  FINAL_CPP=$(comm -23 <(echo "$ALL_CPP" | sort) <(echo "$EXCLUDED_CPP" | sort))
fi

# Convert to .o format
FINAL_OBJS=$(echo "$FINAL_CPP" | sed 's/\.cpp/.o/' | paste -sd " " -)

# ----------------------------
# üì¶ Detect R include directory
R_INCLUDE_DIR=$(R CMD config --cppflags | sed 's/-I//')
echo "‚úÖ R include directory detected at $R_INCLUDE_DIR"


# üõ† Write Makevars
{
  echo "CXX_STD = CXX17"
  echo "PKG_CXXFLAGS = \$(SHLIB_OPENMP_CXXFLAGS) $TBB_CFLAGS -I$(R_INCLUDE_DIR)"
  echo "OBJECTS = $FINAL_OBJS" 
  echo "PKG_OBJECTS = \$(OBJECTS)"

  if [ "$USE_OPENCL" = "1" ]; then
    echo "PKG_CXXFLAGS += -DUSE_OPENCL -I$CL_INC_DIR"
    echo "PKG_LIBS = \$(SHLIB_OPENMP_CXXFLAGS) -L$CL_LIB_DIR -lOpenCL $TBB_LIBS -lstdc++ -lgcc \$(LAPACK_LIBS) \$(BLAS_LIBS) \$(FLIBS)"
  else
    echo "PKG_LIBS = \$(SHLIB_OPENMP_CXXFLAGS) $TBB_LIBS -lstdc++ -lgcc \$(LAPACK_LIBS) \$(BLAS_LIBS) \$(FLIBS)"
  fi
} > src/Makevars


DEBUG_PATH="inst/debug/Makevars_debug"
mkdir -p "$(dirname "$DEBUG_PATH")"

{
  echo "CXX_STD = CXX17"
  echo "PKG_CXXFLAGS = \$(SHLIB_OPENMP_CXXFLAGS) $TBB_CFLAGS -I$R_INCLUDE_DIR"
  echo "OBJECTS = $FINAL_OBJS"
  echo "PKG_OBJECTS = \$(OBJECTS)"

  if [ "$USE_OPENCL" = "1" ]; then
    echo "PKG_CXXFLAGS += -DUSE_OPENCL -I$CL_INC_DIR"
    echo "PKG_LIBS = \$(SHLIB_OPENMP_CXXFLAGS) -L$CL_LIB_DIR -lOpenCL $TBB_LIBS -lstdc++ -lgcc \$(LAPACK_LIBS) \$(BLAS_LIBS) \$(FLIBS)"
  else
    echo "PKG_LIBS = \$(SHLIB_OPENMP_CXXFLAGS) $TBB_LIBS -lstdc++ -lgcc \$(LAPACK_LIBS) \$(BLAS_LIBS) \$(FLIBS)"
  fi
} > "$DEBUG_PATH"

echo "üìù Debug Makevars written to $DEBUG_PATH"

echo "‚úÖ src/Makevars generated with CXX17 support."
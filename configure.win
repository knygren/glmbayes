#!/bin/sh

echo "ğŸ›  [configure.win] Starting OpenCL detection"
echo "Shell = $SHELL"
echo "Initial PATH = $PATH"

##LOG_FILE="C:/Rpackages/configure_debug.txt"
##SECONDARY_MAKEVARS="C:/Rpackages/Makevars.win"

##echo "------ Configure Log (Windows) ------" > "$LOG_FILE"
##echo "Start time: $(date)" >> "$LOG_FILE"

# ğŸ” Get system PATH directories via PowerShell and log them
if command -v powershell.exe >/dev/null 2>&1; then
  echo "ğŸ” Loading MACHINE Path with PowerShell"
  IFS=';' read -ra SYSTEM_PATHS <<< "$(
    powershell.exe -NoProfile -Command "[System.Environment]::GetEnvironmentVariable('Path','Machine')"
  )"
else
  echo "âš ï¸  powershell.exe not found, falling back to msys2 \$PATH"
  IFS=':' read -ra SYSTEM_PATHS <<< "$PATH"
fi

##echo "System PATH directories:" >> "$LOG_FILE"
##for d in "${SYSTEM_PATHS[@]}"; do
##  echo "$d" >> "$LOG_FILE"
##done

# Combine static and dynamic search paths
SEARCH_PATHS=("C:/Program Files (x86)" "C:/OpenCL-SDK" "C:/opt")
SEARCH_PATHS+=("${SYSTEM_PATHS[@]}")

echo "ğŸ” Combined SEARCH_PATHS (n=${#SEARCH_PATHS[@]}): ${SEARCH_PATHS[*]}"

CL_HEADER=""
for dir in "${SEARCH_PATHS[@]}"; do
  if [ -f "$dir\CL\cl.h" ]; then
    CL_HEADER="$dir\CL\cl.h"
    break
  fi
done

echo "ğŸ” CL_HEADER = $CL_HEADER"

# âœ… Write Makevars.win in two locations
if [ -n "$CL_HEADER" ]; then
  CL_BASE=$(dirname "$CL_HEADER")
  INCLUDE_FLAG="-I\"$CL_BASE\""
  LIB_FLAG="-L\"$CL_BASE\\..\\..\\lib\\x64\""

  OPEN_CL_HOME=$(echo "$CL_BASE" | sed 's:[/\\]include[/\\]CL$::')
  OPEN_CL_HOME=$(echo "$OPEN_CL_HOME" | sed 's:\\:/:g')

  INCLUDE_FLAG="-I\"$OPEN_CL_HOME/include\""
  LIB_FLAG="-L\"$OPEN_CL_HOME/lib/x64\""

  echo "âš™ï¸  INCLUDE_FLAG = $INCLUDE_FLAG"
  echo "âš™ï¸  LIB_FLAG     = $LIB_FLAG"

  MAKEVARS_CONTENT="PKG_CXXFLAGS = \$(SHLIB_OPENMP_CXXFLAGS) -DUSE_OPENCL $INCLUDE_FLAG
PKG_LIBS = \$(SHLIB_OPENMP_CXXFLAGS) $LIB_FLAG -lOpenCL  \$(LAPACK_LIBS) \$(BLAS_LIBS) \$(FLIBS)"
else
  MAKEVARS_CONTENT="PKG_CXXFLAGS = \$(SHLIB_OPENMP_CXXFLAGS)
PKG_LIBS = \$(SHLIB_OPENMP_CXXFLAGS)  \$(LAPACK_LIBS) \$(BLAS_LIBS) \$(FLIBS)"
fi

echo "ğŸ“¦ MAKEVARS_CONTENT:"
echo "$MAKEVARS_CONTENT"

# Write to both locations
echo "$MAKEVARS_CONTENT" > src/Makevars.win
##echo "$MAKEVARS_CONTENT" > "$SECONDARY_MAKEVARS"

##echo "End time: $(date)" >> "$LOG_FILE"
##echo "-------------------------------------" >> "$LOG_FILE"